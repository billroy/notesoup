{"syncme":true,"xPos":536,"from":"system in system/widgets","width":250,"imports":"http://chowder.notesoup.net/js-src/js-widgets/message.js","yPos":36,"height":118,"zIndex":3,"bgcolor":"#ccffcc","text":"<script type='text/javascript'>\n/**\n*\tmessage.js - Note Soup message widget\n*\tCopyright 2007 by Bill Roy\n*\tAll rights reserved.\n*/\nvar note = notesoup.ui.getEnclosingNote(this);\nnote.set({\n\n\tsendit: function() {\n\t\tif (!notesoup.loggedin) {\n\t\t\tnotesoup.say('You must be logged in to do that.', 'error');\n\t\t\treturn;\n\t\t}\n\t\tvar tofolder = '';\n\t\tif (this.replyto) tofolder = this.replyto;\n\t\telse {\n\t\t\tvar to = prompt('Send to:', '');\n\t\t\tif (!to) return;\n\t\t\tvar parts = to.split('/');\n\t\t\tif (parts.length == 1) tofolder = to + '/inbox';\n\t\t\telse if (parts.length == 2) tofolder = to;\n\t\t\telse {\n\t\t\t\tnotesoup.say('Address error.');\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// Build a message note to save in the destination\t\t\n\t\tvar thenote = this.cleanNote();\n\t\tdelete thenote.zIndex;\n\n\t\tvar msg = notesoup.username + ': ' + this.getField('messageForm', 'msg');\n\n\t\tif (!thenote.msglog) thenote.msglog = [];\n\t\tthenote.msglog.push(msg);\n\n\t\tif (this.sendCount) {\n\t\t\tthenote.notename = 'Reply from ' + notesoup.username;\n\t\t\tthenote.sendCount++;\n\t\t}\n\t\telse {\n\t\t\tthenote.notename = 'Message from ' + notesoup.username;\n\t\t\tthenote.sendCount = 1;\n\t\t}\n\t\tthenote.replyto = notesoup.foldername;\n\n\t\tnotesoup.postRequest({\n\t\t\tmethod:\"savenote\",\n\t\t\tparams:{\n\t\t\t\tnote: thenote,\n\t\t\t\ttofolder: tofolder,\n\t\t\t\tnotifyfolder:notesoup.foldername\n\t\t\t}},{\n\t\t\tsuccessProc: this.sendCount ? this.quietDelete.createDelegate(this) : this.resetForm.createDelegate(this),\n\t\t\trequestMessage: 'Sending message...',\n\t\t\tfailureMessage: 'Could not deliver the message.  Confirm you have sender rights to the destination.'\n\t\t});\n\t},\n\n\n\tresetForm: function() {\n\t\tthis.setField('messageForm', 'msg', '');\n\t\tnotesoup.say('Message sent.');\n\t},\n\n\n\tquietDelete: function() {\n\t\tnotesoup.postRequest({\n\t\t\tmethod:\"sendnote\",\n\t\t\tparams:{\n\t\t\t\tnoteid: this.id,\n\t\t\t\tfromfolder: notesoup.foldername,\n\t\t\t\ttofolder: notesoup.username + '/trash',\n\t\t\t\tnotifyfolder: notesoup.foldername,\n\t\t\t\tdeleteoriginal: true\n\t\t\t}},{\n\t\t\trequestMessage: 'Message sent.'\n\t\t});\n\t},\n\n\n\tonrender: function() {\n\n\t\tvar messageForm = new Ext.FormPanel({\n\t\t\tlabelWidth: 75,\n\t\t\tlabelalign: 'top',\n\t\t\twidth: this.width - 36,\n\t\t\tbodyStyle: 'background:' + (this.bgcolor || notesoup.ui.defaultNoteColor),\n\t\t\tborder: false,\n\t\t\tbodyBorder: false,\n\t\t\titems: [{\n\t\t\t\txtype: 'textfield',\n\t\t\t\tfieldLabel: ('sendCount' in this) && (this.sendCount > 1) ? 'Reply' : 'Message',\n\t\t\t\tname: 'msg',\n\t\t\t\tid: this.getFieldID('msg'),\n\t\t\t\twidth: this.width - 36 - 86\n\t\t\t}],\n\t\t\tbuttons: [{\n\t\t\t\ttext: 'Send',\n\t\t\t\thandler: this.sendit,\n\t\t\t\tscope: this\n\t\t\t},{\n\t\t\t\ttext: 'Done',\n\t\t\t\thandler: this.destroy,\n\t\t\t\tscope: this\n\t\t\t}],\n\t\t\tkeys: [{\n\t\t\t\tkey: 13,\n\t\t\t\tfn: this.sendit,\n\t\t\t\tscope: this\n\t\t\t}]\n\t\t});\n\n\t\tvar o = [];\n\t\tif (this.msglog) {\n\t\t\tvar m = [];\n\t\t\tfor (var i=0; i < this.msglog.length; i++) m.push(this.msglog[i]);\n\t\t\to.push('<br/>');\n\t\t\to.push(m.reverse().join('<hr/>'));\n\t\t\to.push('<hr/>');\n\t\t}\n\t\to.push('<br/>');\n\t\tthis.setContentDiv(o.join(''));\n\t\tmessageForm.render(this.getContentDiv());\n\t\tthis.setEphemeral('messageForm', messageForm);\n\t}\n});\nnote.show();\n</script>","notename":"Message","mtime":1203791184,"id":"notevAGCtM5m"}