{"xPos":200,"from":"widgets from widgets/auction","bidyinc":42,"width":"250","text":"<script type='text/javascript'>\n/**\n*\tauction.js - Note Soup auction widget\n*\tCopyright 2007 by Bill Roy\n*\tAll rights reserved.\n*/\nvar note = notesoup.ui.getEnclosingNote(this);\nnote.set({\n\txPos: 12,\n\tyPos: 36,\n\n\tbidypos: 228,\n\tbidyinc: 42,\n\n\trunningACL: {\n\t\treaders: '*',\n\t\tsenders: '*'\n\t},\n\tclosedACL: {\n\t\t//readers: '-*',\n\t\tsenders: '-*'\n\t},\n\t\n\tisAuctionOwner: function() {\n\t\treturn (notesoup.loggedin && (notesoup.username == notesoup.foldername.split('/')[0]));\n\t},\n\n\n\tstartAuction: function() {\n\t\tif (!this.running && notesoup.loggedin && this.isAuctionOwner()) {\n\t\t\tvar duration = notesoup.prompt('Starting Auction: How long should the auction last?', '100 seconds');\n\t\t\tif (!duration) return;\n\t\t\tduration = notesoup.getDuration(duration);\n\t\t\tif (!duration) return;\n\t\t\tthis.starttime = new Date().getTime();\n\t\t\tthis.duration = duration;\n\t\t\tthis.endtime = this.starttime + duration;\n\t\t\tthis.auctionuser = notesoup.username;\n\t\t\tnotesoup.setFolderACL(notesoup.foldername, this.runningACL);\n\t\t\tthis.running = true;\n\t\t\tthis.save();\n\t\t\tthis.show();\n\t\t\tnotesoup.say('The auction is running.');\n\t\t}\n\t\telse {\n\t\t\tnotesoup.say('Sorry, only the auction owner can start the auction.', 'error');\n\t\t}\n\t},\n\n\n\tendAuction: function() {\n\t\tif (this.running && this.isAuctionOwner()) {\n\t\t\tthis.running = false;\n\t\t\tnotesoup.say('Ending auction...');\n\t\t\tnotesoup.setFolderACL(notesoup.foldername, this.closedACL);\n\t\t\tnotesoup.folderSay('The auction is closed.');\n\t\t\t\n\t\t\tvar text = this.highbidder ? \n\t\t\t\t'Winning bidder: ' + this.highbidder + '<br/>Winning bid: ' + this.highbid :\n\t\t\t\t'There were no bids.';\n\t\t\t\n\t\t\tnotesoup.saveNote({\n\t\t\t\tnotename: 'Auction ended at ' + new Date(),\n\t\t\t\tbgcolor: 'lime',\n\t\t\t\txPos: this.xPos,\n\t\t\t\tyPos: this.yPos,\n\t\t\t\ttext: '<br/><br/><center>' + text + '</center><br/><br/>'\n\t\t\t}, notesoup.foldername);\n\t\t\tthis.destroy();\n\t\t}\n\t\telse {\n\t\t\tnotesoup.say('Sorry, only the auction owner can end the auction.', 'error');\n\t\t}\n\t},\n\n\n\tbid: function() {\n\t\tif (!notesoup.loggedin || !notesoup.username) {\n\t\t\tnotesoup.say('Sorry, you must be logged in to bid.', 'error');\n\t\t\treturn;\n\t\t}\n\t\tif (!this.running) {\n\t\t\tnotesoup.say('Sorry, the auction is not running.', 'error');\n\t\t\treturn;\n\t\t}\n\t\tvar theForm = this.getEphemeral('auctionForm');\n\t\tvar v = theForm.getValues();\n\t\tvar bidval = v['mybid'];\n\t\tif (!bidval) return;\n\n\t\tvar bid = parseFloat(bidval);\n\t\tif (this.highbid && (bid <= this.highbid)) {\n\t\t\tnotesoup.say('Sorry, your bid must be greater than the current high bid.');\n\t\t\treturn;\n\t\t}\n\t\tnotesoup.say('Submitting your bid: ' + bid);\n\n\t\t//var id = 'noteauctionbid' + notesoup.randomName(20);\n\t\tnotesoup.saveNote({\n\t\t\tnotename: 'bid',\n\t\t\t//id: id,\n\t\t\txPos: 12,\n\t\t\tyPos: this.bidypos,\n\t\t\tapropos: this.id,\n\t\t\tbgcolor: notesoup.ui.defaultNoteColor,\n\t\t\ttext: '' + bid + ' by ' + notesoup.username + ' at ' + new Date()\n\t\t}, notesoup.foldername);\t//notesoup.username + '/inbox');\n\t\t//notesoup.sendNote.defer(2000, notesoup, [id, notesoup.username + '/inbox', notesoup.foldername, true]);\n\t\tthis.getEphemeral('auctionForm').setValues({'mybid':''});\n\t\tthis.bidypos += this.bidyinc;\n\t},\n\n\n\tontick: function() {\n\t\tif (!this.running) return;\n\t\tif (new Date() > this.endtime) {\n\t\t\tif (this.isAuctionOwner()) {\n\t\t\t\tthis.endAuction();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.running = false;\n\t\t\t\tthis.setContentDiv('<br/><br/>The auction has ended...<br/><br/>');\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// update time remaining\n\t\tthis.timeleft = this.endtime - new Date();\n\n\t\t// set the color\n\t\tvar newcolor = '';\n\t\tif (this.timeleft < (15*1000)) newcolor = 'red';\n\t\telse if (this.timeleft < (60*1000)) newcolor = 'yellow';\n\t\tif (newcolor && (newcolor != this.bgcolor)) {\n\t\t\tthis.bgcolor = newcolor;\n\t\t\tthis.show();\n\t\t}\n\n\t\t// find and post high bid\n\t\tthis.highbid = 0.0;\n\t\tthis.highbidder = '';\n\t\tfor (var n in notesoup.notes) {\n\t\t\tif (n == this.id) continue;\n\t\t\tvar thenote = notesoup.notes[n];\n\t\t\tif (thenote.notename != 'bid') continue;\n\n\t\t\tif (!thenote.text || !thenote.from || !thenote.mtime || \n\t\t\t\t(thenote.mtime * 1000 < this.starttime) || (thenote.mtime * 1000 > this.endtime)) {\n\t\t\t\tif (this.isAuctionOwner()) {\n\t\t\t\t\tnotesoup.say('Deleting malformed bid.');\n\t\t\t\t\tthenote.destroy();\n\t\t\t\t\t//notesoup.say(thenote.toJSON());\n\t\t\t\t}\n\t\t\t\telse continue;\n\t\t\t}\n\t\t\tvar bid = parseFloat(thenote.text);\n\t\t\tif (bid > this.highbid)  {\n\t\t\t\tthis.highbid = bid;\n\t\t\t\tthis.highbidder = thenote.from.split(' ')[0];\n\t\t\t}\n\t\t\tif (thenote.yPos >= this.bidypos) {\n\t\t\t\tthis.bidypos = thenote.yPos + this.bidyinc;\n\t\t\t}\n\t\t}\n\n\t\tthis.getEphemeral('auctionForm').setValues({\n\t\t\t'timeleft': notesoup.stringifyTimeDiff(this.timeleft),\n\t\t\t'highbid': this.highbid || 0.00,\n\t\t\t'highbidder': this.highbidder || ''\n\t\t});\n\t},\n\n\n\tonrender: function() {\n\t\n\t\tvar preamble = '';\n\t\tvar auctionForm = new Ext.form.Form({\n\t\t\tlabelWidth: 75,\n\t\t\thideLabels: false\n\t\t});\n\n\t\tif (this.running) {\n\n\t\t\tauctionForm.add(\n\t\t\t\tnew Ext.form.TextField({\n\t\t\t\t\tfieldLabel: 'Time remaining',\n\t\t\t\t\tname: 'timeleft',\n\t\t\t\t\twidth: this.width - 36 - 86\n\t\t\t\t}),\n\t\t\t\tnew Ext.form.NumberField({\n\t\t\t\t\tfieldLabel: 'High bid',\n\t\t\t\t\tname: 'highbid',\n\t\t\t\t\twidth: this.width - 36 - 86\n\t\t\t\t}),\n\t\t\t\tnew Ext.form.TextField({\n\t\t\t\t\tfieldLabel: 'High bidder',\n\t\t\t\t\tname: 'highbidder',\n\t\t\t\t\twidth: this.width - 36 - 86\n\t\t\t\t}),\n\t\t\t\tnew Ext.form.NumberField({\n\t\t\t\t\tfieldLabel: 'Enter your bid here',\n\t\t\t\t\tname: 'mybid',\n\t\t\t\t\twidth: this.width - 36 - 86\n\t\t\t\t})\n\t\t\t);\n\t\n\t\t\tauctionForm.addButton({\n\t\t\t\ttext: 'bid',\n\t\t\t\thandler: this.bid,\n\t\t\t\tscope: this\n\t\t\t});\n\n\t\t\tif (this.isAuctionOwner()) {\n\t\t\t\tauctionForm.addButton({\n\t\t\t\t\ttext: 'end auction',\n\t\t\t\t\thandler: this.endAuction,\n\t\t\t\t\tscope: this\n\t\t\t\t});\n\t\t\t}\n\t\t} \n\t\telse {\n\t\t\tpreamble = '<center><br/><br/>Waiting for the auction owner to start the auction.<br/><br/></center>';\n\t\t\tif (this.isAuctionOwner()) {\t\t\n\t\t\t\tauctionForm.addButton({\n\t\t\t\t\ttext: 'start',\n\t\t\t\t\thandler: this.startAuction,\n\t\t\t\t\tscope: this\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tthis.setContentDiv(preamble);\n\t\tvar thediv = this.getContentDiv();\n\t\tauctionForm.render(thediv);\n\t\tthis.setEphemeral('auctionForm', auctionForm);\n\t\t//Ext.get(thediv).addKeyListener(13, this.bid, this);\n\t}\n});\nnote.show();\n</script>","yPos":50,"runningACL":{"senders":"*","readers":"*"},"bgcolor":"#99CCFF","bidypos":228,"notename":"Auction Widget","mtime":1196981791.764457,"height":142,"id":"noteDsQkygOL","closedACL":{"senders":"-*"}}